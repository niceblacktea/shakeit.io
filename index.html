<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Â§öÈáçÂÆáÂÆôÊäΩÁçéÁ≥ªÁµ±v30.9ÁâàFINAL</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
:root {
  --y2k-blue: #b9d8ff;
  --y2k-purple: #e2d1ff;
  --y2k-dark: rgba(18, 18, 26, 0.95);
  --px-bg: #fdf2d0;
  --px-grid: rgba(220, 210, 180, 0.4);
  --px-win-top: #8cc6d1;
  --px-card: #ffffff;
  --px-border: #3d2b2b;
}

body { margin: 0; padding: 0; height: 100vh; overflow: hidden; font-family: "Noto Sans TC", sans-serif; }

/* --- ÊªæËº™ÂÑ™Âåñ --- */
.theme-cyber ::-webkit-scrollbar { width: 6px; }
.theme-cyber ::-webkit-scrollbar-thumb { background: var(--y2k-blue); border-radius: 10px; }
.theme-pixel ::-webkit-scrollbar { width: 14px; }
.theme-pixel ::-webkit-scrollbar-thumb { background: #ccc; border: 2px solid var(--px-border); }

/* --- ÂÅ¥ÈÇäÊ¨Ñ --- */
.sidebar { 
    position: fixed; top: 0; left: -340px; width: 320px; height: 100%; 
    transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2200; 
    padding: 25px; box-sizing: border-box; display: flex; flex-direction: column;
    box-shadow: 10px 0 30px rgba(0,0,0,0.2);
}
.sidebar.open { left: 0; }
.theme-cyber .sidebar { background: var(--y2k-dark); backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.1); color: #fff; }
.theme-pixel .sidebar { background: var(--px-card); border-right: 4px solid var(--px-border); color: var(--px-border); }

.sidebar-content { flex: 1; overflow-y: auto; padding-right: 5px; }
.setting-group { margin-bottom: 25px; padding-bottom: 20px; }
.theme-cyber .setting-group { border-bottom: 1px solid rgba(255,255,255,0.1); }
.theme-pixel .setting-group { border-bottom: 3px dashed var(--px-border); }

.group-title { display: flex; align-items: center; gap: 6px; font-family: 'Orbitron'; font-size: 13px; font-weight: bold; margin-bottom: 15px; opacity: 0.8; }

/* ‰∏ãÊãâÈÅ∏ÂñÆËàáËº∏ÂÖ•Ê°ÜÊ®£Âºè‰øÆÊ≠£ */
.sidebar input, .sidebar select { 
    width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 6px; 
    box-sizing: border-box; font-size: 14px; transition: 0.3s;
    appearance: none; /* ÁßªÈô§ÂéüÁîüÊ®£Âºè‰ª•Èò≤Âπ≤Êìæ */
}

/* Y2K ‰∏ªÈ°å‰∏ãÁöÑÈÅ∏ÂñÆÊ®£Âºè (Ê∑±Ëâ≤ËÉåÊôØ) */
.theme-cyber .sidebar input, .theme-cyber .sidebar select { 
    background: rgba(255,255,255,0.1); 
    border: 1px solid rgba(255,255,255,0.3); 
    color: #fff; 
}
.theme-cyber .sidebar select option {
    background: #1a1a24; /* Âº∑Âà∂ÈÅ∏ÂñÆÂÖßÈÅ∏È†ÖËÉåÊôØÁÇ∫Ê∑±Ëâ≤ */
    color: #fff;
}

/* Pixel ‰∏ªÈ°å‰∏ãÁöÑÈÅ∏ÂñÆÊ®£Âºè (Ê∑∫Ëâ≤ËÉåÊôØ) */
.theme-pixel .sidebar input, .theme-pixel .sidebar select { 
    border: 3px solid var(--px-border); 
    background: #fff; 
    color: var(--px-border);
    font-weight: bold;
}
.theme-pixel .sidebar select option {
    background: #fff;
    color: var(--px-border);
}

.side-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }

/* --- ‰∏ªÊ°ÜÊû∂ --- */
.theme-cyber { background: linear-gradient(135deg, #cbdcf7 0%, #e2d1ff 50%, #b9d8ff 100%); color: #12121a; }
.theme-pixel { background-color: var(--px-bg); background-image: linear-gradient(var(--px-grid) 1px, transparent 1px), linear-gradient(90deg, var(--px-grid) 1px, transparent 1px); background-size: 25px 25px; }

.container { max-width: 1400px; margin: 0 auto; padding: 10px 20px 20px 20px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; z-index: 10; position: relative; }
.main-grid { display: flex; gap: 20px; flex: 1; min-height: 0; }
.col-left, .col-right { flex: 1; display: flex; flex-direction: column; min-width: 0; }

.card { padding: 20px; margin-bottom: 15px; position: relative; overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
.theme-cyber .card { background: var(--y2k-dark); border: 1.5px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.theme-cyber .card-title { font-family: 'Orbitron'; font-weight: bold; margin-bottom: 15px; border-left: 4px solid var(--y2k-blue); padding-left: 10px; display: flex; align-items: center; gap: 8px; }

.theme-pixel .card { background: var(--px-card); border: 4px solid var(--px-border); box-shadow: 8px 8px 0px rgba(0,0,0,0.1); padding-top: 50px; }
.theme-pixel .card::after { content: "‚ñ† " attr(data-title); position: absolute; top: 0; left: 0; width: 100%; height: 40px; background: var(--px-win-top); border-bottom: 4px solid var(--px-border); color: #fff; font-family: 'VT323'; font-size: 24px; line-height: 40px; padding-left: 15px; box-sizing: border-box; }
.theme-pixel .card-title { display: none; }

.theme-cyber .card-now-playing { height: 350px; }
.theme-pixel .card-now-playing { height: 300px; }

.list-container { flex: 1; overflow-y: auto; padding-right: 10px; }
.display-content { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; text-align: center; position: relative; }

.decor-img { width: 110px; height: 110px; object-fit: contain; }
#decor-left { transform: scaleX(-1); }
.draw-btn { font-family: 'Orbitron'; font-weight: 700; font-size: 36px; cursor: pointer; padding: 10px 65px; border: none; transition: transform 0.05s; border-radius: 50px; outline: none; }
.theme-cyber .draw-btn { background: linear-gradient(90deg, #00d4ff, #cc99ff); color: #12121a; box-shadow: 0 0 20px rgba(0, 212, 255, 0.4); }
.theme-pixel .draw-btn { font-family: 'VT323'; font-size: 44px; background: #ff4757; color: #fff; border: 4px solid var(--px-border); box-shadow: 0 8px 0 var(--px-border); border-radius: 0px; position: relative; top: -8px; margin-bottom: 8px; }

.winner-item { display: flex; align-items: flex-start; padding: 12px 18px; margin-bottom: 12px; gap: 15px; border-radius: 8px; justify-content: flex-start; }
.winner-name-box { flex: 0 0 39%; max-width: 39%; font-size: 24px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; padding-top: 4px; }
.winner-prize-box { flex: 1; text-align: left; display: flex; flex-wrap: wrap; }
.prize-tag { padding: 6px 14px; border-radius: 4px; display: inline-block; line-height: 1.3; }
.prize-no-span { font-family: 'VT323', monospace; font-size: 26px; font-weight: bold; } 
.prize-name-span { font-family: "Noto Sans TC", sans-serif; font-size: 20px; font-weight: 700; } 

.menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 2100; cursor: pointer; width: 42px; height: 42px; background: rgba(0,0,0,0.8); color: #fff; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
.top-bar { display: flex; justify-content: flex-end; align-items: center; gap: 15px; margin-bottom: 5px; height: 50px; }
.stats-bar { display: flex; gap: 20px; font-family: 'Orbitron'; font-size: 24px; font-weight: bold; align-items: center; }
.num-val { min-width: 45px; text-align: center; display: inline-block; }

.export-btn-icon { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.theme-cyber .export-btn-icon { background: #f1c40f; color: #12121a; }
.theme-pixel .export-btn-icon { background: #f1c40f; border: 3px solid var(--px-border); color: var(--px-border); border-radius: 0; }

.fixed-prize-info { position: absolute; top: 0px; width: 100%; display: flex; justify-content: center; z-index: 10; }
.info-capsule { display: flex; align-items: center; gap: 15px; padding: 4px 20px; }
.info-divider { width: 1px; height: 16px; background: currentColor; opacity: 0.5; }
</style>
</head>

<body class="theme-cyber">

<div class="sidebar" id="sidebar">
    <div class="sidebar-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div style="font-family:'Orbitron'; font-size:22px; font-weight:bold; letter-spacing: 2px;">MENU</div>
            <span class="material-icons" style="cursor: pointer; font-size: 24px;" onclick="toggleSidebar()">close</span>
        </div>
        
        <div class="setting-group">
            <div class="group-title"><span class="material-icons">palette</span>THEME SELECT</div>
            <div style="display:flex; gap:10px;">
                <button onclick="changeTheme('theme-cyber')" class="side-btn" style="background:var(--y2k-blue); color: #12121a;">Y2K</button>
                <button onclick="changeTheme('theme-pixel')" class="side-btn" style="background:#fff; border:2px solid #333; color: #333;">PIXEL</button>
            </div>
        </div>

        <div class="setting-group">
            <div class="group-title"><span class="material-icons">file_upload</span>DATA IMPORT</div>
            
            <div style="font-size:11px; margin-bottom:5px; opacity:0.7;">1. PRIZE CATEGORY (A-D)</div>
            <select id="importCategory">
                <option value="A">CATEGORY A</option>
                <option value="B">CATEGORY B</option>
                <option value="C">CATEGORY C</option>
                <option value="D">CATEGORY D</option>
            </select>

            <div style="font-size:11px; margin-bottom:5px; opacity:0.7; margin-top:5px;">2. PARTICIPANTS (.xlsx)</div>
            <input type="file" id="participantFile" accept=".xlsx,.xls">

            <div style="font-size:11px; margin-bottom:5px; opacity:0.7; margin-top:5px;">3. PRIZE LIST (Donor / Name / Qty)</div>
            <input type="file" id="prizeFile" accept=".xlsx,.xls">
        </div>

        <div class="setting-group">
            <div class="group-title"><span class="material-icons">add_circle_outline</span>QUICK ADD</div>
            <select id="quickCategory">
                <option value="A">CATEGORY A</option>
                <option value="B">CATEGORY B</option>
                <option value="C">CATEGORY C</option>
                <option value="D">CATEGORY D</option>
            </select>
            <input type="text" id="quickDonorName" placeholder="Donor Name">
            <input type="text" id="quickPrizeName" placeholder="Prize Name">
            <input type="number" id="quickPrizeQty" value="1" min="1">
            <button onclick="quickAddPrize()" class="side-btn" style="background:#34d399; color:#fff;">
                <span class="material-icons" style="font-size:18px;">add</span>ADD
            </button>
        </div>
    </div>
</div>

<button class="menu-toggle" onclick="toggleSidebar()"><span class="material-icons">widgets</span></button>

<div class="container">
    <div class="top-bar">
        <div class="stats-bar" id="statBar">
            <span>üë§ <span id="pRemStats" class="num-val">0</span> / <span id="pTotalStats" class="num-val">0</span></span>
            <span>üéÅ <span id="gRemStats" class="num-val">0</span> / <span id="gTotalStats" class="num-val">0</span></span>
        </div>
        <button onclick="exportWinners()" class="export-btn-icon" id="exportBtn" title="Export Winners">
            <span class="material-icons">save</span>
        </button>
    </div>

    <div class="main-grid">
        <div class="col-left">
            <div class="card card-now-playing" data-title="NOW_PLAYING">
                <div class="card-title"><span class="material-icons">play_circle</span>NOW PLAYING</div>
                <div id="currentPrizeInfo" class="display-content">
                  <div style="font-family:'Orbitron'; font-size:32px; opacity:0.3;">[ STANDBY ]</div>
                </div>
                <div style="display:flex; justify-content:center; align-items:center; gap:25px; margin-top:15px; min-height:120px;">
                    <img id="decor-left" class="decor-img" src="">
                    <button class="draw-btn" id="drawBtn" onclick="startDraw()">START</button>
                    <img id="decor-right" class="decor-img" src="">
                </div>
            </div>
            <div class="card" data-title="SELECT_PRIZE" style="flex: 1;">
                <div class="card-title"><span class="material-icons">ads_click</span>SELECT PRIZE</div>
                <input type="hidden" id="prizeSelect" value="">
                <div class="list-container" id="prizeList"></div>
            </div>
        </div>
        <div class="col-right">
            <div class="card" data-title="WINNER_WALL" style="flex: 1;">
                <div class="card-title"><span class="material-icons">emoji_events</span>WINNER WALL</div>
                <div class="list-container" id="winnerList"></div>
            </div>
        </div>
    </div>
</div>

<script>
// ÈÇèËºØÈÉ®ÂàÜ‰øùÊåÅ‰∏ÄËá¥ÔºåÂÉÖÈáùÂ∞ç UI ÂºïÁî®ÁöÑ ID ÈÄ≤Ë°åÊìç‰Ωú
const GAS_URL = "https://script.google.com/macros/s/AKfycbwQ3MP-rNwZ5Ls6q5qTi0lObegyrnMYFU-DbwEyKrGMaeohoIjpCRpmHHK8NRyecXVlRg/exec";
let participants = []; let prizes = []; let winners = [];
const y2kColorSchemes = [
    { bg: '#FFD5E5', text: '#5E2B3E', glow: 'rgba(255, 213, 229, 0.6)' }, 
    { bg: '#BFFFE7', text: '#1A4D3B', glow: 'rgba(191, 255, 231, 0.6)' }, 
    { bg: '#E2D1FF', text: '#3E2B5E', glow: 'rgba(226, 209, 255, 0.6)' }, 
    { bg: '#B9D8FF', text: '#2B3E5E', glow: 'rgba(185, 216, 255, 0.6)' }, 
    { bg: '#FFEBBC', text: '#5E492B', glow: 'rgba(255, 235, 188, 0.6)' }  
];
const pixelPalette = ['#f28d7d', '#8cc6d1', '#71aa34', '#fce8a4', '#b19cd9'];
const y2kConfetti = ['#00d4ff', '#cc99ff', '#ffffff', '#ff6b6b', '#39ff14'];
const pixelConfetti = ['#ff4d4d', '#2ec4b6', '#70e000', '#ff9f1c', '#ffff3f'];
let prizeColorMap = {}; let lastColorIndex = -1;

function formatPrizeCode(cat, idx) { return `${cat}${String(idx).padStart(2, '0')}`; }

function updateDecorations() {
    const isCyber = document.body.classList.contains('theme-cyber');
    const leftImg = document.getElementById("decor-left");
    const rightImg = document.getElementById("decor-right");
    const gifUrl = isCyber 
        ? "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExbzc5a3Z4MDZjdTY3YnFidnl2OGwyaTJkbHJlbGZtZzc1MnBpODM4ZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/OqJdWwAvAiLZCovbAR/giphy.gif"
        : "https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExdHlqbW5pcWhrZW82eWN2Y3FhZHgzNGRnMDVndXVsMWFkcHNva2hvYSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/uiLNTtjMiWl2x6sy94/giphy.gif";
    leftImg.src = gifUrl; rightImg.src = gifUrl;
}

function toggleSidebar() { document.getElementById("sidebar").classList.toggle("open"); }

function selectPrize(id) {
    if(!id) return;
    document.getElementById("prizeSelect").value = id;
    const p = prizes.find(pz => pz.id === id);
    if(p) {
        const info = document.getElementById("currentPrizeInfo");
        const isCyber = document.body.classList.contains('theme-cyber');
        const donorHtml = p.donor ? `<div style="font-size:52px; opacity:0.85; margin-bottom:5px;">${p.donor}</div>` : '';
        const nameHtml = `<div style="font-size:58px; font-weight:900; line-height:1.1;">${p.name}</div>`;
        const prizeCode = formatPrizeCode(p.category, p.displayIndex);
        if(isCyber) {
            info.innerHTML = `<div class="fixed-prize-info"><div class="info-capsule" style="font-family:'Orbitron'; border: 1.5px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); border-radius: 50px; color: var(--y2k-blue);"><span>NO. ${prizeCode}</span><div class="info-divider"></div><span>QTY: ${p.initialQty}</span></div></div><div style="margin-top:45px; font-family:'Orbitron', 'Noto Sans TC'; color:white; text-shadow:0 0 15px var(--y2k-blue);">${donorHtml}${nameHtml}</div>`;
        } else {
            info.innerHTML = `<div class="fixed-prize-info"><div class="info-capsule" style="background: #3d2b2b; color: #f1c40f; border: 3px solid #f1c40f; font-family: 'VT323'; font-size: 24px;"><span>NO. ${prizeCode}</span><div class="info-divider" style="background: #f1c40f;"></div><span>QTY: ${p.initialQty}</span></div></div><div style="margin-top:40px; font-family:'Orbitron', 'Noto Sans TC'; font-weight:bold; color:var(--px-border); text-shadow: 4px 4px 0px #fdf2d0, -1px -1px 0px #fff;">${donorHtml}${nameHtml}</div>`;
        }
    }
    render(); 
}

function startDraw() {
    const pid = document.getElementById("prizeSelect").value;
    const prize = prizes.find(p => p.id === pid);
    if(!prize || prize.remain <= 0) return alert("Ë´ãÂÖàÈÅ∏ÊìáÈÇÑÊúâÊï∏ÈáèÁöÑÁçéÈ†Ö");
    
    const pool = participants.filter(p => !p.won);
    if(pool.length === 0) return alert("ÂêçÂñÆÂ∑≤ÂÖ®ÈÉ®ÊäΩÂÆå");

    if (prizeColorMap[pid] === undefined) {
        let newIdx;
        do { newIdx = Math.floor(Math.random() * y2kColorSchemes.length); } while (newIdx === lastColorIndex && y2kColorSchemes.length > 1);
        prizeColorMap[pid] = y2kColorSchemes[newIdx];
        lastColorIndex = newIdx;
    }

    const btn = document.getElementById("drawBtn");
    btn.disabled = true;

    setTimeout(() => {
        const count = Math.min(prize.remain, pool.length);
        const thisBatchWinners = []; 

        for(let i=0; i<count; i++) {
            const idx = Math.floor(Math.random() * pool.length);
            const p = pool.splice(idx, 1)[0];
            p.won = true; 
            prize.remain--;

            const winnerRecord = { 
                name: p.name, 
                prizeId: prize.id, 
                prizeCode: formatPrizeCode(prize.category, prize.displayIndex), 
                prizeName: prize.name, 
                prizeDonor: prize.donor 
            };
            winners.push(winnerRecord);
            thisBatchWinners.push(winnerRecord); 
        }

        // --- Ê†∏ÂøÉÈÄÅË≤®ÂçÄÂ°äÔºöÈÄôÊÆµÊ≤íÂä†ÔºåÂ∞±‰∏çÊúÉÂÇ≥Âà∞ Google Sheet ---
        if (typeof GAS_URL !== 'undefined' && GAS_URL.includes("https")) {
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                cache: "no-cache",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(thisBatchWinners)
            }).then(() => {
                console.log("Ë≥áÊñôÂ∑≤ÊàêÂäüÈÄÅÂá∫Ëá≥ GAS"); 
            }).catch(err => console.error("GAS ÈÄÅÂá∫Â§±Êïó:", err));
        }

        const cColors = document.body.classList.contains('theme-cyber') ? y2kConfetti : pixelConfetti;
        confetti({ particleCount: 100, angle: 60, spread: 55, origin: { x: 0, y: 0.7 }, colors: cColors });
        confetti({ particleCount: 100, angle: 120, spread: 55, origin: { x: 1, y: 0.7 }, colors: cColors });
        
        selectPrize(pid);
        btn.disabled = false;
    }, 300);
}

function render() {
    document.getElementById("pTotalStats").textContent = participants.length;
    document.getElementById("pRemStats").textContent = participants.filter(p => !p.won).length;
    document.getElementById("gTotalStats").textContent = prizes.reduce((a, b) => a + b.initialQty, 0);
    document.getElementById("gRemStats").textContent = prizes.reduce((a, b) => a + b.remain, 0);
    const pList = document.getElementById("prizeList");
    pList.innerHTML = "";
    const isCyber = document.body.classList.contains('theme-cyber');
    [...prizes].sort((a, b) => (a.remain > 0 && b.remain === 0) ? -1 : (a.remain === 0 && b.remain > 0) ? 1 : 0).forEach(p => {
        const d = document.createElement("div");
        const isDone = p.remain === 0;
        const isCurrent = p.id === document.getElementById("prizeSelect").value;
        const prizeCode = formatPrizeCode(p.category, p.displayIndex);
        d.style.cssText = `padding:10px 15px; display:flex; align-items:center; margin-bottom:6px; cursor:${isDone ? 'default' : 'pointer'}; border-radius:6px; opacity: ${isDone ? '0.4' : '1'}; transition:0.2s;`;
        if(isCyber) {
            d.style.border = isCurrent ? "1.5px solid var(--y2k-blue)" : "1px solid rgba(255,255,255,0.1)";
            d.style.background = isCurrent ? "rgba(185, 216, 255, 0.15)" : "rgba(255,255,255,0.05)";
            d.style.color = "#fff";
        } else {
            d.style.border = "4px solid var(--px-border)";
            d.style.background = isCurrent ? "#ffeaa7" : "#fff";
            d.style.color = "var(--px-border)";
        }
        const fullDisplay = (p.donor ? `[${p.donor}] ` : "") + p.name;
        d.innerHTML = `<div style="width:80px; font-family:'VT323'; font-size:22px;">#${prizeCode}</div><div style="flex:1; font-weight:bold; font-size:18px;">${fullDisplay} ${isDone ? '‚úì' : ''}</div><div style="width:40px; text-align:right; font-family:'VT323'; font-size:20px;">${isDone ? 'END' : p.remain}</div>`;
        if(!isDone) d.onclick = () => selectPrize(p.id);
        pList.appendChild(d);
    });
    const wList = document.getElementById("winnerList");
    wList.innerHTML = "";
    winners.slice().reverse().forEach(w => {
        const d = document.createElement("div");
        d.className = "winner-item";
        const fullPrizeDisplay = (w.prizeDonor ? `[${w.prizeDonor}] ` : "") + w.prizeName;
        if(isCyber) { 
            const scheme = prizeColorMap[w.prizeId] || y2kColorSchemes[0];
            d.style.background = "rgba(255,255,255,0.04)"; d.style.border = "1px solid rgba(255,255,255,0.12)";
            d.innerHTML = `<div class="winner-name-box" style="color:#fff;">${formatDisplayName(w.name)}</div><div class="winner-prize-box"><div class="prize-tag" style="background: ${scheme.bg}; color: ${scheme.text};"><span class="prize-no-span">#${w.prizeCode}</span>&nbsp;&nbsp;<span class="prize-name-span">${fullPrizeDisplay}</span></div></div>`;
        } else { 
            const colorIdx = (parseInt(w.prizeCode.substring(1)) - 1) % pixelPalette.length;
            const pxColor = pixelPalette[colorIdx] || '#ccc';
            d.style.backgroundColor = hexToRgba(pxColor, 0.25); d.style.border = `3px solid var(--px-border)`; d.style.boxShadow = `4px 4px 0px ${pxColor}`; 
            d.innerHTML = `<div class="winner-name-box" style="color:var(--px-border); font-size:22px;">${formatDisplayName(w.name)}</div><div class="winner-prize-box"><div class="prize-tag"><span class="prize-no-span">#${w.prizeCode}</span>&nbsp;&nbsp;<span class="prize-name-span">${fullPrizeDisplay}</span></div></div>`;
        }
        wList.appendChild(d);
    });
}

function formatDisplayName(fullName) {
    const match = fullName.match(/^([^„Äî\(\[\Ôºà]+)([„Äî\(\[\Ôºà].*[„Äï\)\ÔºΩ\Ôºâ])$/);
    if (match) return `<span>${match[1]}</span><span style="font-size:0.8em; opacity:0.9; font-weight:800;">${match[2]}</span>`;
    return `<span>${fullName}</span>`;
}
function hexToRgba(hex, alpha) { let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
function changeTheme(theme) { document.body.className = theme; updateDecorations(); const currentId = document.getElementById("prizeSelect").value; if(currentId) selectPrize(currentId); else render(); }

document.getElementById("participantFile").onchange = e => {
    const reader = new FileReader(); reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, {type:'binary'}); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        participants = data.slice(1).filter(r => r[0]).map(r => ({ name: String(r[0]).trim(), won: false })); render();
    }; reader.readAsBinaryString(e.target.files[0]);
};

document.getElementById("prizeFile").onchange = e => {
    const cat = document.getElementById("importCategory").value;
    const reader = new FileReader(); reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, {type:'binary'}); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        const newPrizes = data.slice(1).filter(r => r[1]).map((r, i) => ({ 
            id: 'P'+Date.now()+i, displayIndex: (prizes.filter(x=>x.category === cat).length + i + 1), category: cat,
            donor: String(r[0] || "").trim(), name: String(r[1]).trim(), remain: Number(r[2]||1), initialQty: Number(r[2]||1) 
        }));
        prizes = prizes.concat(newPrizes); if(prizes.length > 0 && !document.getElementById("prizeSelect").value) selectPrize(prizes[0].id); render();
    }; reader.readAsBinaryString(e.target.files[0]);
};

function quickAddPrize() {
    const cat = document.getElementById("quickCategory").value;
    const donorEl = document.getElementById("quickDonorName"); const nameEl = document.getElementById("quickPrizeName"); const qtyEl = document.getElementById("quickPrizeQty");
    const name = nameEl.value.trim(); const qty = parseInt(qtyEl.value);
    if(!name || isNaN(qty) || qty <= 0) return alert("Ë´ãËº∏ÂÖ•Ê≠£Á¢∫Ë≥áË®ä");
    const countInCat = prizes.filter(p => p.category === cat).length;
    const newPrize = { id: 'Q'+Date.now(), displayIndex: countInCat + 1, category: cat, name: name, donor: donorEl.value.trim(), remain: qty, initialQty: qty };
    prizes.push(newPrize); nameEl.value = ""; qtyEl.value = "1";
    if(!document.getElementById("prizeSelect").value) selectPrize(newPrize.id); render();
}

function exportWinners() {
    if (winners.length === 0) return alert("ÁõÆÂâçÂ∞öÁÑ°ÂæóÁçéË≥áÊñôÂèØ‰æõÂåØÂá∫ÔºÅ");
    const data = winners.map(w => ({ "ÂæóÁçéËÄÖÂßìÂêç": w.name, "ÁçéÈ†ÖÁ∑®Ëôü": w.prizeCode, "ÊçêË¥àËÄÖ": w.prizeDonor || "", "ÁçéÈ†ÖÂêçÁ®±": w.prizeName }));
    const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ÂæóÁçéÂêçÂñÆ");
    XLSX.writeFile(wb, `ÂæóÁçéÂêçÂñÆ_${new Date().getTime()}.xlsx`);
}

window.onload = () => { updateDecorations(); };
</script>
</body>
</html>
