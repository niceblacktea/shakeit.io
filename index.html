<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Â§öÈáçÂÆáÂÆôÊäΩÁçéÁ≥ªÁµ± v30.3 - ÊâπÈáèÂêåÊ≠•Áâà</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
/* --- Âü∫Á§éËÆäÊï∏ËàáÊéíÁâà --- */
:root {
  --y2k-blue: #b9d8ff;
  --y2k-purple: #e2d1ff;
  --y2k-dark: rgba(18, 18, 26, 0.95);
  --px-bg: #fdf2d0;
  --px-grid: rgba(220, 210, 180, 0.4);
  --px-win-top: #8cc6d1;
  --px-card: #ffffff;
  --px-border: #3d2b2b;
}

body { margin: 0; padding: 0; height: 100vh; overflow: hidden; font-family: "Noto Sans TC", sans-serif; transition: 0.3s; }

/* --- ÊªæËº™ÂÑ™Âåñ --- */
.theme-cyber ::-webkit-scrollbar { width: 6px; }
.theme-cyber ::-webkit-scrollbar-thumb { background: var(--y2k-blue); border-radius: 10px; }
.theme-pixel ::-webkit-scrollbar { width: 14px; }
.theme-pixel ::-webkit-scrollbar-thumb { background: #ccc; border: 2px solid var(--px-border); }

/* --- ÂÅ¥ÈÇäÊ¨Ñ --- */
.sidebar { 
    position: fixed; top: 0; left: -340px; width: 320px; height: 100%; 
    transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2200; 
    padding: 25px; box-sizing: border-box; overflow-y: auto;
    box-shadow: 10px 0 30px rgba(0,0,0,0.2);
}
.sidebar.open { left: 0; }
.theme-cyber .sidebar { background: var(--y2k-dark); color: #fff; border-right: 1px solid rgba(255,255,255,0.1); }
.theme-pixel .sidebar { background: var(--px-card); border-right: 4px solid var(--px-border); }

.setting-group { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.group-title { display: flex; align-items: center; gap: 6px; font-family: 'Orbitron'; font-size: 13px; font-weight: bold; margin-bottom: 15px; opacity: 0.8; }
.sidebar input { width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 6px; box-sizing: border-box; }
.side-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

/* --- ‰∏ª‰ªãÈù¢ --- */
.theme-cyber { background: linear-gradient(135deg, #cbdcf7 0%, #e2d1ff 50%, #b9d8ff 100%); color: #12121a; }
.theme-pixel { background-color: var(--px-bg); background-image: linear-gradient(var(--px-grid) 1px, transparent 1px), linear-gradient(90deg, var(--px-grid) 1px, transparent 1px); background-size: 25px 25px; }

.container { max-width: 1400px; margin: 0 auto; padding: 20px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; position: relative; z-index: 10; }
.main-grid { display: flex; gap: 20px; flex: 1; min-height: 0; }
.col-left, .col-right { flex: 1; display: flex; flex-direction: column; min-width: 0; }

.card { padding: 20px; margin-bottom: 15px; position: relative; overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
.theme-cyber .card { background: var(--y2k-dark); border: 1.5px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: #fff; }
.theme-pixel .card { background: var(--px-card); border: 4px solid var(--px-border); padding-top: 50px; }
.theme-pixel .card::after { content: "‚ñ† " attr(data-title); position: absolute; top: 0; left: 0; width: 100%; height: 40px; background: var(--px-win-top); border-bottom: 4px solid var(--px-border); color: #fff; font-size: 24px; line-height: 40px; padding-left: 15px; box-sizing: border-box; }

.list-container { flex: 1; overflow-y: auto; }
.display-content { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; text-align: center; }

/* --- ÊåâÈàï --- */
.draw-btn { font-family: 'Orbitron'; font-weight: 700; font-size: 36px; cursor: pointer; padding: 10px 65px; border-radius: 50px; border: none; transition: 0.1s; }
.theme-cyber .draw-btn { background: linear-gradient(90deg, #00d4ff, #cc99ff); color: #12121a; }
.theme-pixel .draw-btn { border-radius: 0; border: 4px solid var(--px-border); box-shadow: 0 8px 0 var(--px-border); background: #ff4757; color: #fff; position: relative; top: -4px; }
.theme-pixel .draw-btn:active { top: 0; box-shadow: 0 0 0 var(--px-border); }

/* --- ÂæóÁçéÊ∏ÖÂñÆÈ†ÖÁõÆ --- */
.winner-item { display: flex; padding: 12px 18px; margin-bottom: 12px; border-radius: 8px; align-items: flex-start; }
.winner-name-box { flex: 0 0 39%; font-size: 24px; font-weight: 700; text-align: left; }
.prize-tag { padding: 6px 14px; border-radius: 4px; display: inline-block; line-height: 1.3; }

.menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 2100; cursor: pointer; width: 42px; height: 42px; background: rgba(0,0,0,0.8); color: #fff; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
.stats-bar { display: flex; justify-content: flex-end; gap: 25px; margin-bottom: 10px; font-family: 'Orbitron'; font-size: 22px; font-weight: bold; }

.fixed-prize-info { position: absolute; top: 10px; width: 100%; display: flex; justify-content: center; z-index: 10; }
.info-capsule { display: flex; align-items: center; gap: 15px; padding: 4px 20px; border-radius: 50px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
</style>
</head>

<body class="theme-cyber">

<div class="sidebar" id="sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div style="font-family:'Orbitron'; font-size:22px; font-weight:bold;">MENU</div>
        <span class="material-icons" style="cursor: pointer;" onclick="toggleSidebar()">close</span>
    </div>

    <div class="setting-group">
        <div class="group-title"><span class="material-icons">palette</span>THEME</div>
        <div style="display:flex; gap:10px;">
            <button onclick="changeTheme('theme-cyber')" class="side-btn" style="background:#b9d8ff;">Y2K</button>
            <button onclick="changeTheme('theme-pixel')" class="side-btn" style="background:#fff; border:1px solid #333;">PIXEL</button>
        </div>
    </div>

    <div class="setting-group">
        <div class="group-title"><span class="material-icons">file_upload</span>DATA IMPORT</div>
        <input type="file" id="participantFile" accept=".xlsx,.xls">
        <input type="file" id="prizeFile" accept=".xlsx,.xls">
    </div>

    <div class="setting-group">
        <div class="group-title"><span class="material-icons">add_circle_outline</span>QUICK ADD</div>
        <input type="text" id="quickDonorName" placeholder="Donor">
        <input type="text" id="quickPrizeName" placeholder="Prize Name">
        <input type="number" id="quickPrizeQty" value="1">
        <button onclick="quickAddPrize()" class="side-btn" style="background:#34d399; color:#fff;">ADD</button>
    </div>
</div>

<button class="menu-toggle" onclick="toggleSidebar()"><span class="material-icons">widgets</span></button>

<div class="container">
    <div class="stats-bar" id="statBar">
        <span>üë§ <span id="pRemStats">0</span> / <span id="pTotalStats">0</span></span>
        <span>üéÅ <span id="gRemStats">0</span> / <span id="gTotalStats">0</span></span>
    </div>

    <div class="main-grid">
        <div class="col-left">
            <div class="card" data-title="NOW_PLAYING" style="height: 320px;">
                <div id="currentPrizeInfo" class="display-content">
                    <div style="font-family:'Orbitron'; font-size:32px; opacity:0.3;">[ STANDBY ]</div>
                </div>
                <div style="display:flex; justify-content:center; margin-top:20px;">
                    <button class="draw-btn" id="drawBtn" onclick="startDraw()">START</button>
                </div>
            </div>
            <div class="card" data-title="SELECT_PRIZE" style="flex: 1;">
                <input type="hidden" id="prizeSelect" value="">
                <div class="list-container" id="prizeList"></div>
            </div>
        </div>
        <div class="col-right">
            <div class="card" data-title="WINNER_WALL" style="flex: 1;">
                <div class="list-container" id="winnerList"></div>
            </div>
        </div>
    </div>
</div>

<script>
// --- ÊâπÈáèÂêåÊ≠•Ë®≠ÂÆö ---
const GAS_URL = "https://script.google.com/macros/s/AKfycbycbH1WvrkQTF-gXyU4BOZcjp9HLIqeGaIizIk5vrFbIImZyRUPN97GW-nsAcT8jCGlOg/exec";

let participants = []; let prizes = []; let winners = [];
const y2kColorSchemes = [{ bg: '#FFD5E5', text: '#5E2B3E' }, { bg: '#BFFFE7', text: '#1A4D3B' }, { bg: '#E2D1FF', text: '#3E2B5E' }, { bg: '#B9D8FF', text: '#2B3E5E' }, { bg: '#FFEBBC', text: '#5E492B' }];
const pixelPalette = ['#f28d7d', '#8cc6d1', '#71aa34', '#fce8a4', '#b19cd9'];
let prizeColorMap = {};

function toggleSidebar() { document.getElementById("sidebar").classList.toggle("open"); }

// ÊâπÈáèÂêåÊ≠•Ëá≥ Google Sheets
function syncBatchToGoogleSheet(winnersArray) {
    if (!GAS_URL || winnersArray.length === 0) return;
    fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        cache: "no-cache",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(winnersArray)
    }).then(() => console.log("Batch sync sent."));
}

function selectPrize(id) {
    if(!id) return;
    document.getElementById("prizeSelect").value = id;
    const p = prizes.find(pz => pz.id === id);
    if(p) {
        const info = document.getElementById("currentPrizeInfo");
        const donorHtml = p.donor ? `<div style="font-size:55px; opacity:0.85; margin-bottom:5px;">${p.donor}</div>` : '';
        const nameHtml = `<div style="font-size:55px; font-weight:900; line-height:1.1;">${p.name}</div>`;
        info.innerHTML = `
            <div class="fixed-prize-info">
                <div class="info-capsule">
                    <span>NO. ${String(p.displayIndex).padStart(2,'0')}</span> | <span>QTY: ${p.initialQty}</span>
                </div>
            </div>
            <div style="margin-top:25px; font-family:'Noto Sans TC';">${donorHtml}${nameHtml}</div>`;
    }
    render(); 
}

function startDraw() {
    const pid = document.getElementById("prizeSelect").value;
    const prize = prizes.find(p => p.id === pid);
    if(!prize || prize.remain <= 0) return alert("SELECT PRIZE FIRST");
    const pool = participants.filter(p => !p.won);
    if(pool.length === 0) return alert("NO PARTICIPANTS");
    
    const btn = document.getElementById("drawBtn");
    btn.disabled = true;
    const thisBatch = []; // Êú¨Ëº™ÂæóÁçéËÄÖ

    setTimeout(() => {
        const count = Math.min(prize.remain, pool.length);
        for(let i=0; i<count; i++) {
            const idx = Math.floor(Math.random() * pool.length);
            const p = pool.splice(idx, 1)[0];
            p.won = true; prize.remain--;
            
            const winObj = { 
                name: p.name, 
                prizeId: prize.id, 
                prizeNo: prize.displayIndex, 
                prizeName: prize.name,
                prizeDonor: prize.donor 
            };
            winners.push(winObj);
            thisBatch.push(winObj);
        }
        
        // --- ÊäΩÂÆåÂæåÂü∑Ë°åÊâπÈáèÂêåÊ≠• ---
        syncBatchToGoogleSheet(thisBatch);

        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        selectPrize(pid); 
        btn.disabled = false;
    }, 300);
}

function render() {
    document.getElementById("pTotalStats").textContent = participants.length;
    document.getElementById("pRemStats").textContent = participants.filter(p => !p.won).length;
    document.getElementById("gTotalStats").textContent = prizes.reduce((a, b) => a + b.initialQty, 0);
    document.getElementById("gRemStats").textContent = prizes.reduce((a, b) => a + b.remain, 0);
    
    const pList = document.getElementById("prizeList");
    pList.innerHTML = "";
    prizes.forEach(p => {
        const isCurrent = p.id === document.getElementById("prizeSelect").value;
        const d = document.createElement("div");
        d.style.cssText = `padding:12px; display:flex; margin-bottom:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.2); border-radius:6px; background:${isCurrent?'rgba(255,255,255,0.2)':'transparent'}`;
        d.innerHTML = `<div style="width:50px;">#${p.displayIndex}</div><div style="flex:1;">[${p.donor}] ${p.name}</div><div>${p.remain}</div>`;
        d.onclick = () => selectPrize(p.id);
        pList.appendChild(d);
    });

    const wList = document.getElementById("winnerList");
    wList.innerHTML = "";
    winners.slice().reverse().forEach(w => {
        const d = document.createElement("div");
        d.className = "winner-item";
        d.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
        const scheme = y2kColorSchemes[w.prizeNo % y2kColorSchemes.length];
        d.innerHTML = `
            <div class="winner-name-box">${w.name}</div>
            <div style="flex:1;">
                <div class="prize-tag" style="background:${scheme.bg}; color:${scheme.text};">
                    <b>#${w.prizeNo}</b> [${w.prizeDonor}] ${w.prizeName}
                </div>
            </div>`;
        wList.appendChild(d);
    });
}

function quickAddPrize() {
    const donor = document.getElementById("quickDonorName").value.trim();
    const name = document.getElementById("quickPrizeName").value.trim();
    const qty = parseInt(document.getElementById("quickPrizeQty").value);
    if(!name || isNaN(qty)) return;
    prizes.push({ id: 'Q'+Date.now(), displayIndex: prizes.length+1, donor, name, remain: qty, initialQty: qty });
    render();
}

function changeTheme(theme) { document.body.className = theme; render(); }

document.getElementById("participantFile").onchange = e => {
    const reader = new FileReader(); reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, {type:'binary'});
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        participants = data.slice(1).filter(r => r[0]).map(r => ({ name: String(r[0]).trim(), won: false }));
        render();
    }; reader.readAsBinaryString(e.target.files[0]);
};

document.getElementById("prizeFile").onchange = e => {
    const reader = new FileReader(); reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, {type:'binary'});
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        prizes = data.slice(1).filter(r => r[1]).map((r, i) => ({ 
            id: 'P'+i, displayIndex: (i + 1), donor: String(r[0] || ""), name: String(r[1]), remain: Number(r[2]||1), initialQty: Number(r[2]||1) 
        }));
        if(prizes.length > 0) selectPrize(prizes[0].id); render();
    }; reader.readAsBinaryString(e.target.files[0]);
};
</script>
</body>
</html>

