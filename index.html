<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ë≥ΩÂçöÊäΩÁçéÁ≥ªÁµ± v8.10</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
:root {
  --bg: #050508;
  --card-bg: rgba(15, 15, 25, 0.9);
  --neon-cyan: #00ffff;
  --neon-pink: #ff00ff;
  --neon-blue: #0077ff;
  --text-primary: #e0e0ff;
  --grid-line: rgba(0, 255, 255, 0.1);
}

body {
  margin: 0; padding: 0; background-color: var(--bg);
  background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
  background-size: 40px 40px; color: var(--text-primary);
  font-family: "Noto Sans TC", sans-serif;
  height: 100vh; overflow: hidden; position: relative;
}

body::after {
  content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
  background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 10;
}

.container {
  max-width: 1450px; margin: 0 auto; padding: 20px;
  height: calc(100vh - 40px); display: flex; flex-direction: column; position: relative; z-index: 5;
}

.card {
  background: var(--card-bg); border: 1px solid var(--neon-cyan);
  box-shadow: 0 0 15px rgba(0, 255, 255, 0.2), inset 0 0 10px rgba(0, 255, 255, 0.1);
  border-radius: 4px; padding: 20px; backdrop-filter: blur(8px); margin-bottom: 15px;
}

.stats-bar { 
  display: flex; justify-content: flex-end; gap: 30px; margin-bottom: 10px; 
  font-size: 26px; color: var(--neon-cyan); font-family: 'VT323';
}
/* Ë™øÊï¥Áµ±Ë®àÂàó Emoji ÁöÑÈñìË∑ù */
.stats-bar .emoji-icon { margin-right: 8px; font-size: 24px; vertical-align: middle; }
.stats-bar .material-icons { vertical-align: middle; font-size: 28px; margin-right: 4px; }

.main-grid { display: flex; gap: 25px; flex: 1; min-height: 0; width: 100%; }
.col-left { flex: 1.1; display: flex; flex-direction: column; min-height: 0; }
.col-right { flex: 0.9; display: flex; flex-direction: column; min-height: 0; }

.draw-control-panel {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 10px !important; height: 260px; overflow: hidden; gap: 5px; 
}

#currentPrizeInfo { font-size: 28px; color: var(--neon-cyan); font-family: 'VT323'; text-align: center; width: 100%; }

.prize-no-row { 
    font-family: 'VT323'; font-size: 32px; color: var(--neon-cyan); 
    text-shadow: 0 0 10px var(--neon-cyan); letter-spacing: 2px;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    margin-bottom: 5px;
}
/* Ë™øÊï¥‰∏ªÈù¢Êùø Emoji ÁöÑÂ§ßÂ∞è */
.prize-no-row .emoji-icon { font-size: 32px; }

.prize-content-row { 
    font-size: 52px; font-weight: 700; line-height: 1.1; 
    display: flex; align-items: center; justify-content: center;
    width: 100%;
}
.prize-name-custom { 
    color: var(--neon-pink); 
    text-shadow: 2px 2px 0px rgba(0,0,0,0.8), 0 0 15px var(--neon-pink);
    word-break: break-all; white-space: normal;   
    max-width: 80%; display: block; text-align: center;
}
.prize-qty-white { 
    font-family: 'VT323'; color: #ffffff; 
    text-shadow: 0 0 12px rgba(255,255,255,0.6); 
    font-size: 52px; margin-left: 15px; flex-shrink: 0;
}

.draw-btn {
  background: none; border: 2px solid var(--neon-cyan); color: var(--neon-cyan);
  padding: 8px 70px; font-family: 'VT323', monospace; font-size: 40px;
  font-weight: bold; cursor: pointer; transition: 0.3s; letter-spacing: 3px;
}
.draw-btn:hover:not(:disabled) { background: var(--neon-cyan); color: #000; box-shadow: 0 0 30px var(--neon-cyan); }

.block-title { font-family: 'Orbitron', sans-serif; font-size: 22px; font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; }
.title-cyan { color: var(--neon-cyan); }
.title-pink { color: var(--neon-pink); }

.list-container { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); }
.item { 
  padding: 12px 15px; margin: 6px 8px; 
  display: flex; justify-content: space-between; align-items: center; 
  font-family: "Noto Sans TC", sans-serif; font-weight: 500;
  border-radius: 4px; border-left: 5px solid transparent;
}

.winner-item { transition: 0.3s transform; font-size: 22px; display: flex; align-items: flex-start; padding: 10px 15px; }
.winner-name { 
    color: #ffffff; text-shadow: 0 0 8px rgba(0,0,0,0.5); 
    font-weight: 700; font-size: 22px; width: 230px; 
    flex-shrink: 0; white-space: nowrap; overflow: visible; margin-right: 15px;
}
.winner-prize-box { display: flex; flex: 1; justify-content: flex-start; align-items: flex-start; }

.prize-index { 
    font-family: 'VT323'; font-size: 28px; font-weight: bold; 
    margin-right: 12px; flex-shrink: 0; line-height: 1;
}
.winner-item .prize-index { color: #ffffff !important; }

.prize-tag { 
    font-size: 20px; padding: 2px 10px; border-radius: 3px; 
    border: 1px solid rgba(255,255,255,0.7); font-weight: 500; 
    color: #ffffff !important; white-space: normal; word-break: break-all; 
    background: rgba(0,0,0,0.3); text-align: left; max-width: 100%; line-height: 1.2;
}

.prize-selector-item { background: rgba(255,255,255,0.03); border-left-color: var(--neon-blue); color: #ccc; font-size: 22px; }
.prize-selector-item.selected { background: rgba(0, 255, 255, 0.15); border-left-color: var(--neon-cyan); color: #fff; }
.prize-selector-item.done { opacity: 0.5; filter: grayscale(1); }

.temp-prize-input-group { padding: 12px 15px; background: rgba(255, 255, 255, 0.05); border-top: 1px solid rgba(0, 255, 255, 0.3); display: flex; gap: 10px; align-items: center; }
.temp-input-field { background: #000; border: 1px solid var(--neon-cyan); color: #fff; padding: 5px 10px; font-family: 'VT323'; font-size: 20px; outline: none; }

.sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: rgba(10, 10, 15, 0.98); border-right: 2px solid var(--neon-cyan); transition: 0.4s; z-index: 2200; padding: 30px 20px; box-sizing: border-box; }
.sidebar.open { left: 0; }

.menu-toggle {
    position: fixed; top: 15px; left: 15px; z-index: 2100; 
    background: rgba(5, 5, 8, 0.8); border: 1px solid var(--neon-cyan); 
    color: var(--neon-cyan); width: 35px; height: 35px; 
    cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.menu-toggle .material-icons { font-size: 20px; }
</style>
</head>

<body>
<div class="sidebar" id="sidebar">
  <span style="position: absolute; top: 20px; right: 20px; font-size: 30px; color: var(--neon-pink); cursor: pointer;" onclick="toggleSidebar()">&times;</span>
  <div style="font-family:'Orbitron'; font-size:24px; color:var(--neon-cyan); border-bottom:1px solid var(--neon-cyan); margin-bottom:20px; padding-top:40px;">CONFIG</div>
  <div style="margin-bottom:20px;">
    <label style="color:var(--neon-cyan); font-size:12px; font-family:'Orbitron';">PARTICIPANTS (XLSX)</label>
    <input type="file" id="participantFile" accept=".xlsx,.xls" style="display:block; margin-top:5px; font-family:'VT323'; color:#fff;">
  </div>
  <div style="margin-bottom:20px;">
    <label style="color:var(--neon-cyan); font-size:12px; font-family:'Orbitron';">PRIZES (XLSX)</label>
    <input type="file" id="prizeFile" accept=".xlsx,.xls" style="display:block; margin-top:5px; font-family:'VT323'; color:#fff;">
  </div>
</div>

<button class="menu-toggle" onclick="toggleSidebar()">
    <span class="material-icons">menu</span>
</button>

<div class="container">
  <div class="stats-bar">
    <span><span class="material-icons">group</span><span id="pRemStats">0</span> / <span id="pTotalStats">0</span></span>
    <span><span class="emoji-icon">üéÅ</span><span id="gRemStats">0</span> / <span id="gTotalStats">0</span></span>
  </div>

  <div class="main-grid">
    <div class="col-left">
      <div class="card draw-control-panel">
        <div id="currentPrizeInfo">
            <div class="prize-no-row"><span class="emoji-icon">üéÅ</span> NO.?</div>
            <div class="prize-content-row"><span class="prize-name-custom">AWAITING DATA...</span></div>
        </div>
        <div style="display:flex; align-items:center; justify-content:center; gap:30px; width: 100%; margin-top: 10px;">
          <img src="https://i.meee.com.tw/0fBYzFD.gif" style="height: 90px;">
          <button class="draw-btn" id="drawBtn" onclick="startDraw()">START</button>
          <img src="https://i.meee.com.tw/0fBYzFD.gif" style="height: 90px; transform: scaleX(-1);">
        </div>
      </div>
      <div class="card" style="flex: 1; display: flex; flex-direction: column; min-height: 0; padding-bottom: 0;">
        <div class="block-title title-cyan">PRIZE SELECTOR</div>
        <input type="hidden" id="prizeSelect">
        <div class="list-container" id="prizeList"></div>
        <div class="temp-prize-input-group">
            <input type="text" id="quickName" placeholder="NEW PRIZE" class="temp-input-field" style="flex:1;">
            <input type="number" id="quickQty" value="1" class="temp-input-field" style="width:65px;">
            <button onclick="addQuickPrize()" style="background:var(--neon-cyan); border:none; color:#000; font-weight:bold; cursor:pointer; padding:6px 15px; font-family:'VT323';">ADD</button>
        </div>
      </div>
    </div>
    <div class="col-right">
      <div class="card" style="height: 100%; display: flex; flex-direction: column; min-height: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div class="block-title title-pink" style="margin-bottom:0;">WINNER LOG</div>
          <div style="display: flex; gap: 5px;">
            <button onclick="copyWinnersToClipboard()" style="background:none; border:1px solid #555; color:#ccc; font-size:14px; cursor:pointer; padding:2px 12px; font-family:'VT323';">COPY</button>
            <button onclick="exportWinnersToExcel()" style="background:none; border:1px solid #555; color:#ccc; font-size:14px; cursor:pointer; padding:2px 12px; font-family:'VT323';">EXCEL</button>
          </div>
        </div>
        <div class="list-container" id="winnerList"></div>
      </div>
    </div>
  </div>
</div>

<script>
let participants = []; let prizes = []; let winners = [];
const GSheetUrl = "https://script.google.com/macros/s/AKfycbzbRT5w5RB6ZyxuZUA8P2Mdl3HP9ucyVJ05M3ZxAaV7axy4TctAp2J5JNyUxuHQxeFfsg/exec";

const prizeColors = [
    { bg: 'rgba(0, 255, 255, 0.15)', border: '#00ffff', text: '#00ffff' },
    { bg: 'rgba(255, 0, 255, 0.15)', border: '#ff00ff', text: '#ff00ff' },
    { bg: 'rgba(255, 255, 0, 0.15)', border: '#ffff00', text: '#ffff00' },
    { bg: 'rgba(0, 119, 255, 0.2)', border: '#0077ff', text: '#0077ff' },
    { bg: 'rgba(255, 120, 0, 0.15)', border: '#ff7800', text: '#ff7800' },
    { bg: 'rgba(180, 0, 255, 0.2)', border: '#b400ff', text: '#b400ff' },
    { bg: 'rgba(0, 255, 100, 0.15)', border: '#00ff64', text: '#00ff64' }
];

function getPrizeStyle(prizeId) {
    const index = prizes.findIndex(p => p.id === prizeId);
    return prizeColors[index % prizeColors.length];
}

// 3. ‰øÆÊîπ JS ÂÖßÁöÑ formatPrizeDisplay ÂáΩÊï∏ÔºåÂ∞áÂúñÁ§∫ÊèõÊàê Emoji
function formatPrizeDisplay(prize) {
    if (!prize) return `<div class="prize-no-row"><span class="emoji-icon">üéÅ</span> NO.?</div><div class="prize-content-row"><span class="prize-name-custom">AWAITING DATA...</span></div>`;
    return `<div class="prize-no-row"><span class="emoji-icon">üéÅ</span> NO.${prize.displayIndex}</div><div class="prize-content-row"><span class="prize-name-custom">${prize.name}</span><span class="prize-qty-white">(${prize.remain})</span></div>`;
}

function render() {
    document.getElementById("pTotalStats").textContent = participants.length;
    document.getElementById("pRemStats").textContent = participants.filter(p => !p.won).length;
    document.getElementById("gTotalStats").textContent = prizes.reduce((a, b) => a + b.initialQty, 0);
    document.getElementById("gRemStats").textContent = prizes.reduce((a, b) => a + b.remain, 0);
    const pList = document.getElementById("prizeList");
    const currentId = document.getElementById("prizeSelect").value;
    pList.innerHTML = "";
    const sorted = [...prizes].sort((a, b) => (a.remain <= 0 ? 1 : 0) - (b.remain <= 0 ? 1 : 0));
    sorted.forEach(p => {
        const isDone = p.remain <= 0;
        const d = document.createElement("div");
        d.className = `item prize-selector-item ${isDone?'done':''} ${p.id===currentId?'selected':''}`;
        d.innerHTML = `<div><span class="prize-index" style="color:var(--neon-cyan)">#${p.displayIndex}</span><span>${p.name}</span></div><strong>${isDone?'FIN':p.remain}</strong>`;
        if(!isDone) d.onclick = () => selectPrize(p.id);
        pList.appendChild(d);
    });
    const wList = document.getElementById("winnerList"); wList.innerHTML = "";
    winners.slice().reverse().forEach(w => {
        const p = prizes.find(pz => pz.id === w.prizeId);
        const style = getPrizeStyle(w.prizeId);
        const d = document.createElement("div"); 
        d.className = "item winner-item";
        d.style.backgroundColor = style.bg;
        d.style.borderLeftColor = style.border;
        d.innerHTML = `<span class="winner-name">${w.name}</span><div class="winner-prize-box"><span class="prize-index">#${p?p.displayIndex:'?'}</span><span class="prize-tag" style="border-color:${style.border}">${p?p.name:'N/A'}</span></div>`;
        wList.appendChild(d);
    });
}

function selectPrize(id) { document.getElementById("prizeSelect").value = id; const p = prizes.find(pz => pz.id === id); if(p) document.getElementById("currentPrizeInfo").innerHTML = formatPrizeDisplay(p); render(); }
function toggleSidebar() { document.getElementById("sidebar").classList.toggle("open"); }

function addQuickPrize() {
    const name = document.getElementById("quickName").value.trim();
    const qty = parseInt(document.getElementById("quickQty").value);
    if(!name || isNaN(qty) || qty <= 0) return;
    const np = { id: 'T'+Date.now(), displayIndex: prizes.length+1, name: name, remain: qty, initialQty: qty };
    prizes.push(np); document.getElementById("quickName").value = ""; selectPrize(np.id);
}

document.getElementById("participantFile").addEventListener("change", e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = evt => { const wb = XLSX.read(evt.target.result, {type:'binary'}); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}); participants = data.slice(1).filter(r => r[0]).map(r => ({ name: String(r[0]).trim(), won: false })); render(); }; reader.readAsBinaryString(file); });
document.getElementById("prizeFile").addEventListener("change", e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = evt => { const wb = XLSX.read(evt.target.result, {type:'binary'}); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}); prizes = data.slice(1).filter(r => r[0]).map((r, i) => ({ id: 'P'+i, displayIndex: (i + 1), name: String(r[0]).trim(), remain: Number(r[1]||1), initialQty: Number(r[1]||1) })); if(prizes.length > 0) selectPrize(prizes[0].id); render(); }; reader.readAsBinaryString(file); });

function startDraw() {
    const pid = document.getElementById("prizeSelect").value; const prize = prizes.find(p => p.id === pid);
    if(!prize || prize.remain <= 0) return alert("SELECT PRIZE");
    const pool = participants.filter(p => !p.won); if(pool.length === 0) return alert("EMPTY");
    const btn = document.getElementById("drawBtn"); btn.disabled = true;
    const take = Math.min(prize.remain, pool.length);
    const picked = pool.sort(() => Math.random() - 0.5).slice(0, take);
    
    setTimeout(() => {
        const syncData = [];
        picked.forEach(p => { 
            p.won = true; prize.remain--; 
            const wObj = { name: p.name, prizeId: prize.id, timestamp: Date.now() }; 
            winners.push(wObj); syncData.push(wObj); 
        });
        const end = Date.now() + 400; 
        const colors = ['#00ffff', '#ff00ff', '#ffffff', '#0077ff'];
        (function frame() {
            confetti({ particleCount: 7, angle: 60, spread: 55, origin: { x: 0, y: 0.8 }, colors: colors });
            confetti({ particleCount: 7, angle: 120, spread: 55, origin: { x: 1, y: 0.8 }, colors: colors });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
        render();
        if (prize.remain <= 0) {
            const next = prizes.find(p => p.remain > 0);
            if (next) selectPrize(next.id);
            else document.getElementById("currentPrizeInfo").innerHTML = `<span style="color:var(--neon-pink); font-size:40px;">ALL DRAWN</span>`;
        } else {
            document.getElementById("currentPrizeInfo").innerHTML = formatPrizeDisplay(prize);
        }
        autoSyncWinner(syncData); btn.disabled = false;
    }, 500);
}

function autoSyncWinner(newWinners) { if (!GSheetUrl) return; const exportData = newWinners.map(w => ({ '‰∏≠Áçé‰∫∫ÂßìÂêç': w.name, 'ÁçéÈ†ÖÂêçÁ®±': prizes.find(p => p.id === w.prizeId).name, 'ÊôÇÈñì': new Date(w.timestamp).toLocaleString() })); const iframe = document.createElement('iframe'); iframe.name = 'sf_' + Date.now(); iframe.style.display = 'none'; document.body.appendChild(iframe); const form = document.createElement('form'); form.action = GSheetUrl; form.method = 'POST'; form.target = iframe.name; const input = document.createElement('input'); input.type = 'hidden'; input.name = 'json_data'; input.value = JSON.stringify({ winners: exportData }); form.appendChild(input); document.body.appendChild(form); form.submit(); setTimeout(() => { form.remove(); iframe.remove(); }, 3000); }
function exportWinnersToExcel() { const data = winners.map(w => ({ 'ÂßìÂêç': w.name, 'ÁçéÈ†Ö': prizes.find(p=>p.id===w.prizeId)?.name, 'ÊôÇÈñì': new Date(w.timestamp).toLocaleString() })); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "WINNERS"); XLSX.writeFile(wb, `Log_${Date.now()}.xlsx`); }
function copyWinnersToClipboard() { const text = winners.map(w => `${w.name}\t${prizes.find(p=>p.id===w.prizeId)?.name}`).join("\n"); navigator.clipboard.writeText(text).then(() => alert("COPIED")); }
</script>
</body>
</html>
