<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>抽獎系統 - 自動同步版</title>

<style>
/* 保持您原有的精美樣式 */
:root{ --bg:#f8fafc; --card:#ffffff; --main:#6366f1; --main-dark:#4f46e5; --accent:#f59e0b; --text-primary:#0f172a; --text-secondary:#475569; --prize-done:#f1f5f9; --prize-border:#e2e8f0; }
body{ margin:0; font-family:"Noto Sans TC",system-ui; background:var(--bg); color:var(--text-primary); height: 100vh; overflow: hidden; }
.container{ max-width:1200px; margin:10px auto; padding:10px 16px; height: calc(100vh - 20px); box-sizing: border-box; display: flex; flex-direction: column; }
.card{ background:var(--card); border-radius:18px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,.05); border: 1px solid #e5e7eb; }
button{ cursor:pointer; border:none; font-weight:700; border-radius:10px; padding:10px 14px; transition: 0.2s; }
.primary{ background:var(--main); color:white; width: 100%; font-size: 20px; }
.primary:hover{ background:var(--main-dark); }
.runner{ margin:10px 0 15px 0; height:120px; display:flex; flex-direction: column; align-items:center; justify-content:center; background:linear-gradient(180deg,#eef2ff,#fff); border-radius:18px; flex-shrink: 0; }
.runner .winner-name-result { font-size: 40px; font-weight: 900; color: var(--main); }
.stats{ display:flex; justify-content:flex-end; gap: 20px; font-size:14px; color:var(--text-secondary); margin-bottom: 10px; }
.two-column-layout { display: flex; gap: 20px; flex-grow: 1; min-height: 0; }
.left-column, .right-column { flex: 1; display: flex; flex-direction: column; gap: 10px; min-height: 0; }
.prize-list, .winner-list-scroll { flex-grow: 1; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 10px; background: white; }
.prize-item { padding: 12px; margin: 5px 10px; border-radius: 8px; border: 1px solid var(--prize-border); cursor: pointer; }
.prize-item.selected { background: var(--main); color: white; }
.winner-item { padding:10px; margin: 5px 10px; border-left: 5px solid var(--main); background: #f1f5f9; display: flex; justify-content: space-between; }
/* 側邊欄與其他樣式省略，保持與您提供的版本一致 */
.sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: white; z-index: 1000; transition: 0.3s; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
.sidebar.open { left: 0; }
.sidebar-toggle { position: fixed; top: 15px; left: 15px; z-index: 1001; background: var(--main); color: white; padding: 10px; border-radius: 8px; cursor: pointer; }
</style>
</head>

<body>
<div class="sidebar" id="sidebar">
    <h3>名單匯入</h3>
    <label>參加者 (Excel):</label><input type="file" id="participantFile" accept=".xlsx,.xls"><br><br>
    <label>獎項 (Excel):</label><input type="file" id="prizeFile" accept=".xlsx,.xls">
    <button onclick="toggleSidebar()" style="margin-top:20px; width:100%">關閉</button>
</div>
<div class="sidebar-toggle" onclick="toggleSidebar()">☰</div>

<div class="container">
    <div class="stats">
        <div>總人數：<strong id="totalCnt">0</strong></div>
        <div>剩餘人數：<strong id="remainCnt">0</strong></div>
    </div>

    <div class="two-column-layout">
        <div class="left-column">
            <div class="card">
                <div class="runner" id="runner">
                    <div id="currentPrizeInfo">請選擇獎項</div>
                    <div class="winner-name-result" id="winnerDisplay">準備抽獎</div>
                </div>
                <button class="primary" onclick="startDraw()">開始抽獎</button>
            </div>
            <div class="card" style="flex-grow:1; display:flex; flex-direction:column;">
                <h3>選擇獎項</h3>
                <input type="hidden" id="prizeSelect">
                <div class="prize-list" id="prizeList"></div>
            </div>
        </div>

        <div class="right-column">
            <div class="card" style="flex-grow:1; display:flex; flex-direction:column;">
                <h3>中獎名單</h3>
                <div class="winner-list-scroll">
                    <div id="winnerList"></div>
                </div>
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <button onclick="copyWinnersToClipboard()" style="flex:1">複製</button>
                    <button onclick="exportWinnersToExcel()" style="flex:1">匯出</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// --- 初始化資料 ---
let participants = [];
let prizes = [];
let winners = [];
const GSheetUrl = "https://script.google.com/macros/s/AKfycbzbRT5w5RB6ZyxuZUA8P2Mdl3HP9ucyVJ05M3ZxAaV7axy4TctAp2J5JNyUxuHQxeFfsg/exec"; // <<< 務必替換為您的網址

// --- 介面渲染功能 ---
function render() {
    const pList = document.getElementById("prizeList");
    pList.innerHTML = prizes.map(p => `
        <div class="prize-item ${p.remain<=0?'done':''} ${document.getElementById('prizeSelect').value===p.id?'selected':''}" 
             onclick="${p.remain>0?`selectPrize('${p.id}')`:''}">
            ${p.name} (剩餘: ${p.remain})
        </div>
    `).join('');
    
    document.getElementById("winnerList").innerHTML = winners.slice().reverse().map(w => `
        <div class="winner-item">
            <span>${w.name}</span>
            <span style="font-size:12px; color:gray;">${prizes.find(p=>p.id===w.prizeId)?.name}</span>
        </div>
    `).join('');
    
    document.getElementById("totalCnt").textContent = participants.length;
    document.getElementById("remainCnt").textContent = participants.filter(p=>!p.won).length;
}

function selectPrize(id) {
    document.getElementById("prizeSelect").value = id;
    document.getElementById("currentPrizeInfo").textContent = "目前獎項：" + prizes.find(p=>p.id===id).name;
    render();
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

// --- 抽獎邏輯 ---
function startDraw() {
    const pId = document.getElementById("prizeSelect").value;
    const prize = prizes.find(p => p.id === pId);
    if (!prize || prize.remain <= 0) return alert("請選擇有效獎項");

    const pool = participants.filter(p => !p.won);
    if (pool.length === 0) return alert("已無可抽獎人數");

    const winner = pool[Math.floor(Math.random() * pool.length)];
    winner.won = true;
    prize.remain--;

    const newEntry = { name: winner.name, prizeId: pId, timestamp: new Date().toLocaleString() };
    winners.push(newEntry);
    
    document.getElementById("winnerDisplay").textContent = winner.name;
    render();

    // 觸發自動同步
    autoSyncWinner([newEntry]);
}

// --- 核心同步功能 (隱藏表單版) ---
function autoSyncWinner(newEntries) {
    if (!GSheetUrl) return;

    const payload = JSON.stringify({ 
        winners: newEntries.map(e => ({
            '中獎人姓名': e.name,
            '獎項名稱': prizes.find(p=>p.id===e.prizeId).name,
            '時間戳': e.timestamp
        }))
    });

    // 建立隱藏 iframe 與表單
    let iframe = document.getElementById('sync-iframe') || document.createElement('iframe');
    iframe.id = 'sync-iframe'; iframe.name = 'sync-iframe'; iframe.style.display = 'none';
    if (!iframe.parentNode) document.body.appendChild(iframe);

    const form = document.createElement('form');
    form.action = GSheetUrl; form.method = 'POST'; form.target = 'sync-iframe'; form.style.display = 'none';

    const input = document.createElement('input');
    input.type = 'hidden'; input.name = 'json_data'; input.value = payload;
    
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();

    // 監聽回傳結果
    const handleMsg = (event) => {
        if (event.origin !== "https://script.google.com") return;
        if (event.data.success) console.log("✅ 同步成功");
        window.removeEventListener('message', handleMsg);
        document.body.removeChild(form);
    };
    window.addEventListener('message', handleMsg);
}

// --- Excel 匯入處理 ---
document.getElementById("participantFile").addEventListener("change", e => {
    const reader = new FileReader();
    reader.onload = evt => {
        const sheet = XLSX.read(evt.target.result, {type:'binary'}).Sheets[XLSX.read(evt.target.result, {type:'binary'}).SheetNames[0]];
        participants = XLSX.utils.sheet_to_json(sheet, {header:1}).slice(1).map(r => ({name: r[0], won: false}));
        render();
    };
    reader.readAsBinaryString(e.target.files[0]);
});

document.getElementById("prizeFile").addEventListener("change", e => {
    const reader = new FileReader();
    reader.onload = evt => {
        const sheet = XLSX.read(evt.target.result, {type:'binary'}).Sheets[XLSX.read(evt.target.result, {type:'binary'}).SheetNames[0]];
        prizes = XLSX.utils.sheet_to_json(sheet, {header:1}).slice(1).map((r, i) => ({id: 'P'+i, name: r[0], remain: r[1], initial: r[1]}));
        render();
    };
    reader.readAsBinaryString(e.target.files[0]);
});

// 複製與匯出功能保持原樣即可...
</script>
</body>
</html>

